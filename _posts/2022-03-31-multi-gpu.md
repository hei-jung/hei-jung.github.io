<https://tutorials.pytorch.kr/beginner/blitz/data_parallel_tutorial.html><br>
<https://stackoverflow.com/questions/54216920/how-to-use-multiple-gpus-in-pytorch><br>

```python
import os
import torch
from torch import nn
from resnet import *
```

---


```python
# OPTION 1.
# this code should be run very first
os.environ["CUDA_DEVICE_ORDER"] = "PCI_BUS_ID"
os.environ["CUDA_VISIBLE_DEVICES"] = "1,2"
```


```python
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

model = resnet26(in_channels=1, num_classes=1)  # resnet26

model= nn.DataParallel(model)
model.to(device)
```

---


```python
# OPTION 2.
# this gives RuntimeError: Invalid device string: 'cuda:1,2'
device = torch.device("cuda:1,2" if torch.cuda.is_available() else "cpu")

model = resnet26(in_channels=1, num_classes=1)  # resnet26

model= nn.DataParallel(model,device_ids=[1,2])
model.to(device)
```

---


```python
torch.cuda.get_device_name()
```




    'NVIDIA RTX A6000'




```python
# if device is not specified, this will print 4
# if specific devices are set, this will print the number of them
torch.cuda.device_count()
```




    2




```python
torch.cuda.current_device()
```




    0



---


```python
# test-code
from torch.utils.data import Dataset, DataLoader

# parameter and dataloaders
input_size = 1000
output_size = 2

batch_size = 30
data_size = 1000
```


```python
# Dummy Dataset
class RandomDataset(Dataset):
    
    def __init__(self, size, length):
        self.len = length
        self.data = torch.randn(length, size)
        
    def __getitem__(self, index):
        return self.data[index]
    
    def __len__(self):
        return self.len
```


```python
rand_loader = DataLoader(dataset=RandomDataset(input_size, data_size), batch_size=batch_size, shuffle=True)
```


```python
class Model(nn.Module):
    # 우리의 모델

    def __init__(self, input_size, output_size):
        super(Model, self).__init__()
        self.fc = nn.Linear(input_size, output_size)

    def forward(self, input):
        output = self.fc(input)
        print("\tIn Model: input size", input.size(),
              "output size", output.size())

        return output
```


```python
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

model = Model(input_size, output_size)

model= nn.DataParallel(model)
model.to(device)
```




    DataParallel(
      (module): Model(
        (fc): Linear(in_features=1000, out_features=2, bias=True)
      )
    )




```python
torch.cuda.device_count()
```




    2




```python
print("Let's use", torch.cuda.device_count(), "GPUs!")
for data in rand_loader:
    input = data.to(device)
    output = model(input)
    print("Outside: input size", input.size(),
          "output_size", output.size())
```

    Let's use 2 GPUs!
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size 	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
     torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
     torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size	In Model: input size torch.Size([15, 1000]) output size  torch.Size([15, 1000]) output size torch.Size([15, 2])
    torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) 	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
     torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])	In Model: input size
     torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size 	In Model: input size torch.Size([15, 1000]) torch.Size([15, 1000]) output size output size torch.Size([15, 2])
    torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    	In Model: input size torch.Size([15, 1000]) output size torch.Size([15, 2])
    Outside: input size torch.Size([30, 1000]) output_size torch.Size([30, 2])
    	In Model: input size torch.Size([5, 1000]) output size	In Model: input size torch.Size([5, 1000]) output size  torch.Size([5, 2])
    torch.Size([5, 2])
    Outside: input size torch.Size([10, 1000]) output_size torch.Size([10, 2])

